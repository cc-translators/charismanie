\ProvidesPackage{charismanie}

% Nicer centering + ragged
\usepackage[newcommands]{ragged2e}

% Number lines
\usepackage{lineno}

% PDF settings
\usepackage[breaklinks=true,unicode=true]{hyperref}
\hypersetup{colorlinks, 
           citecolor=black,
           filecolor=black,
           linkcolor=black,
           urlcolor=black,
           bookmarksopen=true,
           pdfpagelayout=TwoPageRight,
           pdfauthor={Chuck Smith},
           pdftitle={Charismatique ou Charismaniaque ?}}

\usepackage{url}
%\usepackage[activate={true,nocompatibility}]{microtype}
\usepackage[protrusion=true,final]{microtype}

% Include cover as PDF
\usepackage{pdfpages}

\usepackage[english,french]{babel} %language selection
\selectlanguage{french}

\usepackage{amsmath}
\usepackage[mathletters]{ucs}
%\usepackage[utf8x]{inputenc}

% nice serif font
%\usepackage[T1]{fontenc}
%\usepackage{lmodern}
%\usepackage{libertine}

% Use fourier ornaments
\usepackage{fourier-orns}

% bible references
\usepackage{bibleref-french-colombe}

% header and footer
\usepackage[automark]{scrpage2}

% Use ifpdf
\usepackage{ifpdf}

% Make indexes
\newcommand{\indextitle}{Index des r\'ef\'erences bibliques}
\usepackage{imakeidx}
\indexsetup{firstpagestyle=scrheadings}
\makeindex[name=bibleref,title=\indextitle,intoc,options=-s bibleref.ist,columns=2]
\renewcommand{\biblerefindex}{\index[bibleref]}
% Only reference Bible chapters in index
%\usepackage[verses]{bibleref-xidx}

% Patch bibleref to sort Bible books properly
\usepackage{etoolbox}
\makeatletter
\patchcmd{\@bible@verse}{\@bv@idxsort{\csname br@#1\endcsname}}{\@bv@idxsort{#1}}
\makeatother


% setting lettrines
\usepackage{type1cm} % scalable fonts
\usepackage{lettrine}
\usepackage{xcolor}
% set paragraphs

\hfuzz = .6pt % avoid black boxes

\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}

%\setcounter{secnumdepth}{0}

% set split mode for debug
\makeatletter
\newcommand{\@config@split}{0}
\makeatother

% Set fonts
\usepackage{fontspec}
\usepackage{xunicode}
%\defaultfontfeatures{Mapping=tex-text}
\defaultfontfeatures{Ligatures=TeX}
\setmainfont{Linux Libertine O}
%\setmainfont{Linden Hill}
%\setmainfont{Fanwood Text}

%\newfontfamily\normalfont{Linux Libertine O}
\newfontface\pagemarkfont[Numbers={OldStyle}]{Linux Libertine O}
\newfontfamily\chapfont{EB Garamond}
%\newfontfamily\chapheadfont[Scale=1.2]{Latino Elongated LET}
%\newfontfamily\chapheadfont{League Gothic}
%\newfontfamily\chapheadfont{Fontin-Bold}
%\newfontfamily\chapheadfont[Scale=2]{TulpenOne-Regular}
\newfontfamily\chapheadfont[Scale=1.2]{SteelfishRg-Regular}
%\newfontfamily\chapheadfont{WireOne}
%\newfontfamily\chapheadfont{NimbusSanL-ReguCond}
%\newfontfamily\chapheadfont{NimbusSanL-BoldCond}
%\newfontfamily\chaptocfont[Scale=1.4,
%                           SmallCapsFont={LatinoElongatedLetPlainSC.otf},
%                           SmallCapsFeatures={Letters=SmallCaps}]{LatinoElongatedLetPlainSC.otf}
%\newfontfamily\chaptocfont[Scale=1.4]{League Gothic}
%\newfontfamily\chaptocfont{Fontin-Bold}
%\newfontfamily\chaptocfont{Fontin-SmallCaps}
\newfontfamily\chaptocfont{SteelfishRg-Regular}
\newfontfamily\secfont{EB Garamond}
\newfontfamily\headerfont{LinLibertineCapitalsO}
%\newfontfamily\lettrinefont{Linux Libertine Initials O}
\newfontfamily\lettrinefont{LinLibertineIO}
%\DeclareMicrotypeAlias{Linux Libertine O}{cmr}



% Make nice chapter headings
\usepackage{titlesec}
\newcommand{\chapstyle}{\chapfont\raggedleft\Large\itshape}
\newcommand{\chapheadstyle}{\chapheadfont\LARGE}
\titleformat{\chapter}[display]
  {\chapstyle}
  {\chaptertitlename\ \thechapter}{0pt}
  {\chapheadstyle}
\titlespacing*{\chapter}
  {0pt}{0pt}{0pt}

\newcommand{\secstyle}{\secfont\large\itshape}
\titleformat{\section}%
  {\secstyle} % format
  {} % label
  {10pt} % sep
  {} % before
  [\normalfont] % after
\titlespacing*{\section}
  {0pt}{10pt}{0pt}

% Get title
\makeatletter
\let\titlehead\@title
\makeatother

% setting table of contents
%\ifpdf
\usepackage{tocloft}

% No scshape...
% horrible hack
%\newcommand\fakesc[1]{\scalebox{0.7}{\MakeUppercase{#1}}}
%\newcommand{\mychaptertitlename}{{\normalsize{C}}{\footnotesize{\,HAPITRE}}\;\normalsize}

\renewcommand{\thesection}{}

%\renewcommand\cftchapfont{\chaptocfont }
\renewcommand\cftchappresnum{\lsstyle\chaptertitlename\;}
\renewcommand\cftchapaftersnumb{\linebreak\normalfont}
% Make long chapter names fit (chap 11)
\renewcommand\cftchapfont{\hspace{0.3em}\chaptocfont }
%\setlength{\cftchapindent}{-1em}

% Homogenous dotfill for chapters and sections alike
\renewcommand\cftchapleader{\cftdotfill{1}}
\renewcommand\cftsecleader{\cftdotfill{1}}
\renewcommand\cftchappagefont{\normalfont}
%\fi


\newcommand{\myshorttoc}{%
  % Sommaire
  \begingroup
  \renewcommand{\chapstyle}{\centering}
  \renewcommand{\chapheadstyle}{\chapheadfont\LARGE}
  \titlespacing*{\chapter}
    {0pt}{-4em}{0.5em}
  \setlength{\cftchapindent}{-1.5em}
  % Reduce skip between chapter entries
  \setlength{\cftbeforechapskip}{-0.2em}
  \shorttableofcontents{Sommaire}{0}
  \endgroup
}


\newcommand{\mylongtoc}{%
  \cohead[\headerfont\textls{\contentsname}]{}
  \renewcommand\cfttoctitlefont{\vspace{-1em}\hfill\chaptocfont\lsstyle\Huge\scshape}
  \renewcommand\cftaftertoctitle{\hfill}
  \setlength{\cftchapindent}{-1.5em}
  \tocloftpagestyle{scrheadings}
  \addcontentsline{toc}{chapter}{\contentsname}
  \tableofcontents
}


% Define \chaphead to be used in section headings
\newcommand{\setchaphead}{%
  \let\oldchapter\chapter
  \newcommand\temphead{}
  \newcommand\chaphead{}
  \renewcommand\chapter[2][\temphead]{%
    \cleardoublepage
    \renewcommand\temphead{##2}%
    \ifx ##1 \@empty
       \renewcommand\chaphead{##2}%
    \else
       \renewcommand\chaphead{##1}%
    \fi
    \oldchapter[##1]{##2}}
}

\newcommand{\restorechaphead}{%
  \let\chapter\oldchapter
}

% Set headers and footers
%\automark[chapter]{section}
%\setheadsepline{.4pt}

% 
% chapter headings => scrheadings
% plain => scrplain
% chapter endings => chapterend
%

%\SetTracking{encoding={*},family={LinuxLibertineCapitalsO}}{300}


\renewcommand{\pnumfont}{\pagemarkfont}
\cfoot[\rule{6mm}{0.8pt}\\\pagemark]{\rule{6mm}{0.8pt}\\\pagemark}
\ofoot[]{}
\lehead[]{}
\cehead[\headerfont\textls{\titlehead}]{}
\ohead[]{}

\newcommand{\setbookheadings}{%
  \cohead[\headerfont\textls{\chaphead}]{}
}

\defpagestyle{chapterend}%
  {%
    {\hfill\headerfont\textls{\titlehead}\hfill}
    {\hfill\headerfont\textls{\chaphead}\hfill}
    {}
  }%
  {{}{}{}} % Nothing in footer

\defpagestyle{indexend}%
  {%
    {\hfill\headerfont\textls{\titlehead}\hfill}
    {\hfill\headerfont\textls{\indextitle}\hfill}
    {}
  }%
  {{}{}{}} % Nothing in footer

\defpagestyle{tocend}%
  {%
    {\hfill\headerfont\textls{\titlehead}\hfill}
    {\hfill\headerfont\textls{\contentsname}\hfill}
    {}
  }%
  {{}{}{}} % Nothing in footer

\defpagestyle{prefaceend}%
  {%
    {\hfill\headerfont\textls{\titlehead}\hfill}
    {\hfill\headerfont\textls{Pr√©face}\hfill}
    {}
  }%
  {{}{}{}} % Nothing in footer

\renewcommand*{\chapterpagestyle}{scrheadings}

\newcommand{\closechapter}[1][chapterend]{
   \begingroup\widowpenalties 6 10000 10000 10000 10000 10000 0
   \par\endgroup
   \mbox{}\hfill
   \thispagestyle{#1}}

% Set index
\newcommand{\biblerefindex}{%
  % Restore normal chapters
  \restorechaphead
  % Appendix
  %\ifpdf
    \cohead[\headerfont\textls{\indextitle}]{}
  %\fi
  \renewcommand{\chapstyle}{\centering}
  \renewcommand{\chapheadstyle}{\chapheadfont\LARGE}
  \titlespacing*{\chapter}
    {0pt}{1em}{5em}
  \renewcommand*{\BRbooktitlestyle}[1]{\textbf{\emph{##1}}\vadjust{\nobreak}}
  %\def\imki@firstpagestyle{scrheadings}
  \printindex[bibleref]
}

% Creative Commons
%\usepackage{ccicons}


\usepackage{impnattypo}

% Allow emergency stretch
%\emergencystretch=1.5em
%\emergencystretch=1.7em
%\tolerance=270
%\tolerance=300

% Define specialpar environment to fix hyphenation issues
% Sample usage:
%   \begin{specialpar}{\tolerance=274 \BRallowhypbch}
% or
%   \begin{specialpar}{\emergencystretch=1.5em}
\newenvironment{specialpar}[1]{\par#1}{\par}


% Control widows
\def\nowidowX#1{%
    \ifnum#1<\nowidowmax
        10000
        \expandafter\nowidowX\expandafter{\the\numexpr(#1)+1\expandafter\relax\expandafter}%
    \fi
}

\newcommand{\nowidow}[1][2]{%
    \begingroup
    \mathchardef\nowidowmax#1\relax
    \widowpenalties #1 \nowidowX{1} 0\par
    \endgroup
}


% Make shorttocs
\usepackage{shorttoc}

% Dumb text
\usepackage{lipsum}


%%%%%%%%%%%%%%%%%
% Useful macros
%%%%%%%%%%%%%%%%%

\usepackage{xspace}
\usepackage{numprint}

% Bullet
\newcommand{\mybullet}{{\color[gray]{0.7}$\bullet$}\xspace}

% NdT macro
\newcommand{\NdT}[1]{\footnote{NdT~: #1}}

% Seigneur macro
\newcommand{\Seigneur}{\textsc{Seigneur}\xspace}

% Rule for titles
\newcommand{\HRule}{\rule{\linewidth}{0.2mm}}

% lettrines
\renewcommand{\LettrineFontHook}{\lettrinefont\color[gray]{0.3}}

% cadratin
\newcommand*{\ocadr}{\mbox{---}\nobreak\,\nobreak}
\newcommand*{\fcadr}{\unskip\nobreak\,\nobreak{}---}

% demi-cadratin
\newcommand*{\odcadr}{\mbox{--}\nobreak\thinspace\nobreak}
\newcommand*{\fdcadr}{\unskip\nobreak\thinspace\nobreak{}--}


